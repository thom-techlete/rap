{% extends 'base.html' %}

{% block title %}
  {{ poll.title }} bewerken - SV Rap 8
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'polls:list' %}">Polls</a></li>
            <li class="breadcrumb-item"><a href="{% url 'polls:detail' poll.pk %}">{{ poll.title }}</a></li>
            <li class="breadcrumb-item active">Bewerken</li>
          </ol>
        </nav>
        
        <h1 class="h2 mb-2">Poll Bewerken</h1>
        <p class="text-muted mb-0">Bewerk de poll "{{ poll.title }}".</p>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <form method="post" id="poll-form">
          {% csrf_token %}
          
          <!-- Basic Information -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basis Informatie</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label for="{{ form.title.id_for_label }}" class="form-label">
                    Titel <span class="text-danger">*</span>
                  </label>
                  {{ form.title }}
                  {% if form.title.errors %}
                    <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
                  {% endif %}
                  <div class="form-text">{{ form.title.help_text }}</div>
                </div>
                
                <div class="col-12">
                  <label for="{{ form.description.id_for_label }}" class="form-label">
                    Beschrijving
                  </label>
                  {{ form.description }}
                  {% if form.description.errors %}
                    <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
                  {% endif %}
                  <div class="form-text">{{ form.description.help_text }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Poll Options -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Poll Opties</h5>
              {% if poll.total_votes > 0 %}
                <span class="badge bg-warning">
                  <i data-feather="alert-triangle" class="me-1" style="width: 14px; height: 14px;"></i>
                  {{ poll.total_votes }} stemmen ontvangen
                </span>
              {% endif %}
            </div>
            <div class="card-body">
              {% if poll.total_votes > 0 %}
                <div class="alert alert-warning">
                  <i data-feather="alert-triangle" class="me-2"></i>
                  <strong>Let op:</strong> Deze poll heeft al {{ poll.total_votes }} stemmen ontvangen. 
                  Het wijzigen van opties kan invloed hebben op bestaande resultaten.
                </div>
              {% endif %}
              
              {{ formset.management_form }}
              
              <div id="poll-options">
                {% for option_form in formset %}
                  <div class="poll-option row g-3 mb-3 align-items-end">
                    <div class="col-md-8">
                      <label for="{{ option_form.text.id_for_label }}" class="form-label">
                        Optie {{ forloop.counter }} <span class="text-danger">*</span>
                        {% if option_form.instance.pk and option_form.instance.vote_count > 0 %}
                          <span class="badge bg-info ms-2">{{ option_form.instance.vote_count }} stemmen</span>
                        {% endif %}
                      </label>
                      {{ option_form.text }}
                      {% if option_form.text.errors %}
                        <div class="text-danger small mt-1">{{ option_form.text.errors.0 }}</div>
                      {% endif %}
                    </div>
                    
                    <div class="col-md-3">
                      <label for="{{ option_form.order.id_for_label }}" class="form-label">
                        Volgorde
                      </label>
                      {{ option_form.order }}
                      {% if option_form.order.errors %}
                        <div class="text-danger small mt-1">{{ option_form.order.errors.0 }}</div>
                      {% endif %}
                    </div>
                    
                    <div class="col-md-1">
                      {% if option_form.instance.pk and option_form.instance.vote_count > 0 %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="Kan niet verwijderen: heeft stemmen">
                          <i data-feather="lock"></i>
                        </button>
                      {% else %}
                        <button type="button" class="btn btn-outline-danger btn-sm remove-option">
                          <i data-feather="trash-2"></i>
                        </button>
                      {% endif %}
                      {{ option_form.DELETE }}
                    </div>
                    
                    {{ option_form.id }}
                  </div>
                {% endfor %}
              </div>
              
              <button type="button" class="btn btn-outline-primary btn-sm" id="add-option">
                <i data-feather="plus" class="me-2"></i>Optie Toevoegen
              </button>
              
              {% if formset.non_form_errors %}
                <div class="alert alert-danger mt-3">
                  {{ formset.non_form_errors }}
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Poll Settings -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0">Instellingen</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-check">
                    {{ form.allow_multiple_choices }}
                    <label class="form-check-label" for="{{ form.allow_multiple_choices.id_for_label }}">
                      Meerdere antwoorden toestaan
                      {% if poll.total_votes > 0 and not poll.allow_multiple_choices %}
                        <span class="badge bg-warning ms-2">Vastgezet</span>
                      {% endif %}
                    </label>
                    {% if form.allow_multiple_choices.errors %}
                      <div class="text-danger small mt-1">{{ form.allow_multiple_choices.errors.0 }}</div>
                    {% endif %}
                    <div class="form-text">
                      {{ form.allow_multiple_choices.help_text }}
                      {% if poll.total_votes > 0 %}
                        <br><strong>Let op:</strong> Dit kan niet meer gewijzigd worden omdat er al stemmen zijn uitgebracht.
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <label for="{{ form.end_date.id_for_label }}" class="form-label">
                    Automatische sluitdatum
                  </label>
                  {{ form.end_date }}
                  {% if form.end_date.errors %}
                    <div class="text-danger small mt-1">{{ form.end_date.errors.0 }}</div>
                  {% endif %}
                  <div class="form-text">{{ form.end_date.help_text }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i data-feather="save" class="me-2"></i>Wijzigingen Opslaan
            </button>
            <a href="{% url 'polls:detail' poll.pk %}" class="btn btn-outline-secondary">
              <i data-feather="x" class="me-2"></i>Annuleren
            </a>
          </div>
        </form>
      </div>

      <!-- Help Sidebar -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i data-feather="info" class="me-2"></i>Poll Status
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-1">{{ poll.total_votes }}</div>
                  <div class="small text-muted">Totale stemmen</div>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-1">{{ poll.unique_voters }}</div>
                  <div class="small text-muted">Unieke stemmers</div>
                </div>
              </div>
              <div class="col-12">
                <div class="d-flex align-items-center gap-2">
                  {% if poll.is_open %}
                    <span class="badge bg-success">Open</span>
                    <span class="small text-muted">Ontvangt nog stemmen</span>
                  {% else %}
                    <span class="badge bg-secondary">Gesloten</span>
                    <span class="small text-muted">Ontvangt geen stemmen meer</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card border-0 shadow-sm">
          <div class="card-header">
            <h5 class="mb-0">
              <i data-feather="help-circle" class="me-2"></i>Bewerkingshulp
            </h5>
          </div>
          <div class="card-body">
            <h6>Bewerkingsbeperkingen</h6>
            <ul class="small text-muted">
              <li>Opties met stemmen kunnen niet verwijderd worden</li>
              <li>Keuzemodus kan niet gewijzigd worden na eerste stem</li>
              <li>Titel en beschrijving kunnen altijd gewijzigd worden</li>
            </ul>
            
            <h6 class="mt-3">Nieuwe opties toevoegen</h6>
            <p class="small text-muted">
              Je kunt altijd nieuwe opties toevoegen, ook als er al gestemd is. 
              Bestaande stemmen blijven behouden.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript for dynamic form management -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const optionsContainer = document.getElementById('poll-options');
      const addOptionBtn = document.getElementById('add-option');
      const multipleChoicesField = document.getElementById('{{ form.allow_multiple_choices.id_for_label }}');
      
      // Disable multiple choices field if there are votes
      {% if poll.total_votes > 0 %}
        if (multipleChoicesField) {
          multipleChoicesField.disabled = true;
        }
      {% endif %}
      
      // Add option functionality
      addOptionBtn.addEventListener('click', function() {
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const formIndex = parseInt(totalForms.value);
        
        const newOptionHtml = `
          <div class="poll-option row g-3 mb-3 align-items-end">
            <div class="col-md-8">
              <label for="id_form-${formIndex}-text" class="form-label">
                Optie ${formIndex + 1} <span class="text-danger">*</span>
              </label>
              <input type="text" name="form-${formIndex}-text" class="form-control" id="id_form-${formIndex}-text" placeholder="Voer optie tekst in...">
            </div>
            
            <div class="col-md-3">
              <label for="id_form-${formIndex}-order" class="form-label">
                Volgorde
              </label>
              <input type="number" name="form-${formIndex}-order" class="form-control" id="id_form-${formIndex}-order" value="${formIndex}" min="0">
            </div>
            
            <div class="col-md-1">
              <button type="button" class="btn btn-outline-danger btn-sm remove-option">
                <i data-feather="trash-2"></i>
              </button>
              <input type="hidden" name="form-${formIndex}-DELETE" id="id_form-${formIndex}-DELETE">
              <input type="hidden" name="form-${formIndex}-id" id="id_form-${formIndex}-id">
            </div>
          </div>
        `;
        
        optionsContainer.insertAdjacentHTML('beforeend', newOptionHtml);
        totalForms.value = formIndex + 1;
        
        // Re-initialize feather icons
        if (window.feather) {
          feather.replace();
        }
        
        updateOptionNumbers();
      });
      
      // Remove option functionality
      optionsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-option')) {
          const optionDiv = e.target.closest('.poll-option');
          const deleteInput = optionDiv.querySelector('input[name$="-DELETE"]');
          
          if (deleteInput) {
            deleteInput.value = 'on';
            optionDiv.style.display = 'none';
          } else {
            optionDiv.remove();
          }
          
          updateOptionNumbers();
        }
      });
      
      function updateOptionNumbers() {
        const visibleOptions = optionsContainer.querySelectorAll('.poll-option:not([style*="display: none"])');
        visibleOptions.forEach((option, index) => {
          const label = option.querySelector('label[for*="text"]');
          if (label && !label.querySelector('.badge')) {
            label.innerHTML = `Optie ${index + 1} <span class="text-danger">*</span>`;
          }
        });
      }
    });
  </script>
{% endblock %}
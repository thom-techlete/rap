<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <title>
      {% block title %}
        SV Rap 8 - Aanwezigheid
      {% endblock %}
    </title>

    {% load static %}
    {% load static_versioning %}

    <!-- PWA Meta Tags -->
    <meta name="description" content="Voetbalvereniging aanwezigheid beheer systeem voor SV Rap 8" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="SV Rap 8" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="SV Rap 8" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static_v 'manifest.json' %}" />
    
    <!-- Favicon and PWA Icons -->
    <link rel="icon" type="image/x-icon" href="{% static_v 'media/favicon.ico' %}" />
    <link rel="icon" type="image/png" sizes="192x192" href="{% static_v 'media/icons/icon-192x192.png' %}" />
    <link rel="apple-touch-icon" href="{% static_v 'media/icons/icon-192x192.png' %}" />
    <link rel="apple-touch-icon" sizes="152x152" href="{% static_v 'media/icons/icon-152x152.png' %}" />
    <link rel="apple-touch-icon" sizes="144x144" href="{% static_v 'media/icons/icon-144x144.png' %}" />
    <link rel="apple-touch-icon" sizes="128x128" href="{% static_v 'media/icons/icon-128x128.png' %}" />
    <link rel="apple-touch-icon" sizes="96x96" href="{% static_v 'media/icons/icon-96x96.png' %}" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.css" />

    <!-- Styles -->
    {% static_v_css 'css/style.css' %}
    {% block extra_css %}
    {% endblock %}
  </head>
  <body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-brand">
          <a href="/" class="nav-logo">
            {% static_v_img 'media/sv-rap.png' alt_text='SV Rap Logo' css_class='logo-image' %}
            <span class="brand-text">SV Rap 8</span>
          </a>
        </div>

        {% if user.is_authenticated %}
          <!-- Desktop Navigation Menu -->
          <div class="nav-menu">
            <a href="/" class="nav-link">
              <i data-feather="home"></i>
              <span>Dashboard</span>
            </a>
            
            {% if user.is_invaller %}
              <!-- Invaller-specific menu items -->
              <a href="{% url 'events:invaller_matches' %}" class="nav-link">
                <i data-feather="trophy"></i>
                <span>Wedstrijden</span>
              </a>
            {% else %}
              <!-- Regular player menu items -->
              <a href="{% url 'events:list' %}" class="nav-link">
                <i data-feather="calendar"></i>
                <span>Evenementen</span>
              </a>
              <a href="{% url 'attendance:dashboard' %}" class="nav-link">
                <i data-feather="users"></i>
                <span>Aanwezigheid</span>
              </a>
              <a href="{% url 'events:analytics' %}" class="nav-link">
                <i data-feather="bar-chart-2"></i>
                <span>Analytics</span>
              </a>
            {% endif %}
            
            {% if user.is_staff %}
              <a href="{% url 'users:admin_dashboard' %}" class="nav-link">
                <i data-feather="settings"></i>
                <span>Beheer</span>
              </a>
            {% endif %}
          </div>

          <!-- Desktop User Menu -->
          <div class="nav-user">
            <div class="user-menu">
              <button class="user-button" onclick="toggleUserMenu()" aria-label="Gebruikersmenu">
                <div class="user-avatar{% if not user.foto %} default{% endif %}">
                  {% if user.foto %}
                    <img src="{{ user.foto.url }}" alt="{{ user.get_full_name }}" />
                  {% else %}
                    <div class="avatar-fallback">
                      {% if user.firstname %}
                      {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                      {% else %}
                      {{ user.username|first|upper }}
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
                <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                <i data-feather="chevron-down" class="user-chevron"></i>
              </button>
              <div class="user-dropdown" id="userDropdown">
                <a href="{% url 'users:profile' %}" class="dropdown-item">
                  <i data-feather="user"></i>
                  <span>Profiel</span>
                </a>
                <a href="#" onclick="openNotificationSettings(); return false;" class="dropdown-item">
                  <i data-feather="bell"></i>
                  <span>Notificaties</span>
                </a>
                <a href="{% url 'help:index' %}" class="dropdown-item">
                  <i data-feather="help-circle"></i>
                  <span>Hulp</span>
                </a>
                {% if user.is_staff %}
                  <a href="{% url 'users:admin_dashboard' %}" class="dropdown-item">
                    <i data-feather="settings"></i>
                    <span>Admin Dashboard</span>
                  </a>
                {% endif %}
                <form method="post" action="{% url 'users:logout' %}">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">
                    <i data-feather="log-out"></i>
                    <span>Uitloggen</span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        {% else %}
          <!-- Desktop Auth Links -->
          <div class="nav-auth">
            <a href="{% url 'users:login' %}" class="btn btn-ghost">Inloggen</a>
            <a href="{% url 'users:register' %}" class="btn btn-primary">Registreren</a>
          </div>
        {% endif %}

        <!-- Mobile menu button -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu openen"><i data-feather="menu"></i></button>
      </div>
    </nav>

    <!-- Mobile menu -->
    <div class="mobile-menu" id="mobileMenu">
      {% if user.is_authenticated %}
        <div class="mobile-user">
          <div class="mobile-avatar{% if not user.foto %} default{% endif %}">
            {% if user.foto %}
              <img src="{{ user.foto.url }}" alt="{{ user.get_full_name }}" />
            {% else %}
              <div class="avatar-fallback">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</div>
            {% endif %}
          </div>
          <div class="mobile-user-info">
            <div class="mobile-user-name">{{ user.get_full_name|default:user.username }}</div>
            <div class="mobile-user-role">
              {% if user.is_invaller %}Invaller{% else %}{{ user.positie|default:'Speler' }}{% endif %}
            </div>
          </div>
        </div>
        <div class="mobile-nav-links">
          <a href="/" class="mobile-nav-link">
            <i data-feather="home"></i>
            <span>Dashboard</span>
          </a>
          
          {% if user.is_invaller %}
            <!-- Invaller-specific mobile menu items -->
            <a href="{% url 'events:invaller_matches' %}" class="mobile-nav-link">
              <i data-feather="trophy"></i>
              <span>Wedstrijden</span>
            </a>
          {% else %}
            <!-- Regular player mobile menu items -->
            <a href="{% url 'events:list' %}" class="mobile-nav-link">
              <i data-feather="calendar"></i>
              <span>Evenementen</span>
            </a>
            <a href="{% url 'attendance:dashboard' %}" class="mobile-nav-link">
              <i data-feather="users"></i>
              <span>Aanwezigheid</span>
            </a>
            <a href="{% url 'events:analytics' %}" class="mobile-nav-link">
              <i data-feather="bar-chart-2"></i>
              <span>Analytics</span>
            </a>
          {% endif %}
          {% if user.is_staff %}
            <a href="{% url 'users:admin_dashboard' %}" class="mobile-nav-link">
              <i data-feather="settings"></i>
              <span>Beheer</span>
            </a>
          {% endif %}
          <a href="{% url 'users:profile' %}" class="mobile-nav-link">
            <i data-feather="user"></i>
            <span>Profiel</span>
          </a>
          <a href="#" onclick="openNotificationSettings(); return false;" class="mobile-nav-link">
            <i data-feather="bell"></i>
            <span>Notificaties</span>
          </a>
          <a href="{% url 'help:index' %}" class="mobile-nav-link">
            <i data-feather="help-circle"></i>
            <span>Hulp</span>
          </a>
          <form method="post" action="{% url 'users:logout' %}">
            {% csrf_token %}
            <button type="submit" class="mobile-nav-link">
              <i data-feather="log-out"></i>
              <span>Uitloggen</span>
            </button>
          </form>
        </div>
      {% else %}
        <div class="mobile-auth">
          <a href="{% url 'users:login' %}" class="btn btn-ghost btn-block">Inloggen</a>
          <a href="{% url 'users:register' %}" class="btn btn-primary btn-block">Registreren</a>
        </div>
      {% endif %}
    </div>

    <!-- Main content -->
    <main class="flex-grow-1 py-4">
      <div class="container">
        {% block content %}

        {% endblock %}
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-brand">
            <div class="footer-logo">
              {% static_v_img 'media/sv-rap.png' alt_text='SV Rap Logo' width='50' height='50' css_class='logo-image' %}
              <span>SV Rap 8</span>
            </div>
            <p class="footer-description">Voetbalvereniging aanwezigheid beheer systeem</p>
          </div>
          <div class="footer-links">
            <div class="footer-section">
              <h4>Navigatie</h4>
              <a href="/">Dashboard</a>
              <a href="{% url 'events:list' %}">Evenementen</a>
              <a href="{% url 'attendance:dashboard' %}">Aanwezigheid</a>
              <a href="{% url 'events:analytics' %}">Analytics</a>
            </div>
            <div class="footer-section">
              <h4>Account</h4>
              <a href="{% url 'users:profile' %}">Profiel</a>
              {% if user.is_staff %}
                <a href="{% url 'users:admin_dashboard' %}">Beheer</a>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 SV Rap 8. Alle rechten voorbehouden.</p>
        </div>
      </div>
    </footer>

    <!-- Profile Completion Popup -->
    {% include 'components/profile_completion_popup.html' %}

    <!-- Notification Settings Modal -->
    {% include 'components/notification_settings.html' %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"></script>
    {% static_v_js 'js/app.js' %}
    
    <!-- PWA Service Worker Registration -->
    <script>
      // Make VAPID public key available globally
      {% if settings.VAPID_PUBLIC_KEY %}
        window.vapidPublicKey = "{{ settings.VAPID_PUBLIC_KEY }}";
      {% endif %}
      
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/static/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
              
              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New content is available
                    if (confirm('Er is een nieuwe versie beschikbaar. Wil je de pagina verversen?')) {
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }

      // Push Notification Support
      window.pushNotificationSupport = {
        isSupported: () => {
          return 'serviceWorker' in navigator && 'PushManager' in window;
        },
        
        requestPermission: async () => {
          if (!('Notification' in window)) {
            return false;
          }
          
          const permission = await Notification.requestPermission();
          return permission === 'granted';
        },
        
        subscribe: async () => {
          if (!navigator.serviceWorker.ready) {
            return null;
          }
          
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: window.vapidPublicKey || null
          });
          
          return subscription;
        },
        
        unsubscribe: async () => {
          if (!navigator.serviceWorker.ready) {
            return false;
          }
          
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          
          if (subscription) {
            return await subscription.unsubscribe();
          }
          
          return true;
        }
      };
    </script>
    
    <script>
    {% if messages %}
        {% for message in messages %}
            showNotification("{{ message|escapejs }}", "{{ message.tags }}");
        {% endfor %}
    {% endif %}
    </script>
    {% block extra_js %}

    {% endblock %}
  </body>
</html>

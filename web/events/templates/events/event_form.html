{% extends 'base.html' %}
{% load static %}

{% block title %}
  {% if event %}
    Evenement bewerken - SV Rap 8
  {% else %}
    Nieuw evenement aanmaken - SV Rap 8
  {% endif %}
{% endblock %}

{% block extra_css %}
  <!-- Flatpickr CSS for datepicker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/bootstrap.css" />
  <link rel="stylesheet" href="{% static 'css/events/event_form.css' %}" />
{% endblock %}

{% block content %}
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-dark mb-3">
      {% if event %}
        <i data-feather="edit-2" style="width: 2.5rem; height: 2.5rem; margin-right: 1rem; color: var(--primary-600);"></i>
        Evenement bewerken
      {% else %}
        <i data-feather="plus" style="width: 2.5rem; height: 2.5rem; margin-right: 1rem; color: var(--primary-600);"></i>
        Nieuw evenement aanmaken
      {% endif %}
    </h1>
    <p class="lead text-muted">
      {% if event %}
        Pas de gegevens van het evenement aan en sla de wijzigingen op
      {% else %}
        Vul de gegevens in om een nieuw evenement toe te voegen
      {% endif %}
    </p>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h2 class="card-title h5 mb-0">
            <i data-feather="calendar" style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem;"></i>
            Evenement details
          </h2>
        </div>

        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="row g-3">
              <!-- Event Name -->
              <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label fw-medium">
                  {{ form.name.label }}
                  {% if form.name.field.required %}
                    <span class="text-error">*</span>
                  {% endif %}
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                  <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Event Type -->
              <div class="col-md-6">
                <label for="{{ form.event_type.id_for_label }}" class="form-label fw-medium">
                  {{ form.event_type.label }}
                  {% if form.event_type.field.required %}
                    <span class="text-error">*</span>
                  {% endif %}
                </label>
                {{ form.event_type }}
                {% if form.event_type.errors %}
                  <div class="invalid-feedback d-block">{{ form.event_type.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Date and Time -->
              <div class="col-md-6">
                <label for="{{ form.date.id_for_label }}" class="form-label fw-medium">
                  {{ form.date.label }}
                  {% if form.date.field.required %}
                    <span class="text-error">*</span>
                  {% endif %}
                </label>
                <div class="input-group">
                  {{ form.date }}
                  <span class="input-group-text"><i data-feather="calendar" style="width: 1rem; height: 1rem;"></i></span>
                </div>
                {% if form.date.help_text %}
                  <div class="form-text">{{ form.date.help_text }}</div>
                {% endif %}
                {% if form.date.errors %}
                  <div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Location -->
              <div class="col-md-6">
                <label for="{{ form.location.id_for_label }}" class="form-label fw-medium">
                  {{ form.location.label }}
                  {% if form.location.field.required %}
                    <span class="text-error">*</span>
                  {% endif %}
                </label>
                {{ form.location }}
                {% if form.location.errors %}
                  <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Max Participants -->
              <div class="col-md-6">
                <label for="{{ form.max_participants.id_for_label }}" class="form-label fw-medium">{{ form.max_participants.label }}</label>
                {{ form.max_participants }}
                {% if form.max_participants.help_text %}
                  <div class="form-text">{{ form.max_participants.help_text }}</div>
                {% endif %}
                {% if form.max_participants.errors %}
                  <div class="invalid-feedback d-block">{{ form.max_participants.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Mandatory Attendance -->
              <div class="col-md-6">
                <div class="form-check mt-4">
                  {{ form.is_mandatory }}
                  <label for="{{ form.is_mandatory.id_for_label }}" class="form-check-label fw-medium">{{ form.is_mandatory.label }}</label>
                  {% if form.is_mandatory.help_text %}
                    <div class="form-text">{{ form.is_mandatory.help_text }}</div>
                  {% endif %}
                  {% if form.is_mandatory.errors %}
                    <div class="invalid-feedback d-block">{{ form.is_mandatory.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>

              <!-- Description -->
              <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label fw-medium">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.help_text %}
                  <div class="form-text">{{ form.description.help_text }}</div>
                {% endif %}
                {% if form.description.errors %}
                  <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                {% endif %}
              </div>

              <!-- Recurring Event Section -->
              {% if not event %}
                <div class="col-12">
                  <hr class="my-4" />
                  <h5 class="mb-3">
                    <i data-feather="repeat" style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem;"></i>
                    Herhalend evenement
                  </h5>
                </div>

                <!-- Recurrence Type -->
                <div class="col-md-6">
                  <label for="{{ form.recurrence_type.id_for_label }}" class="form-label fw-medium">{{ form.recurrence_type.label }}</label>
                  {{ form.recurrence_type }}
                  {% if form.recurrence_type.help_text %}
                    <div class="form-text">{{ form.recurrence_type.help_text }}</div>
                  {% endif %}
                  {% if form.recurrence_type.errors %}
                    <div class="invalid-feedback d-block">{{ form.recurrence_type.errors.0 }}</div>
                  {% endif %}
                </div>

                <!-- Recurrence End Date -->
                <div class="col-md-6" id="recurrence-end-date-field" style="display: none;">
                  <label for="{{ form.recurrence_end_date.id_for_label }}" class="form-label fw-medium">
                    {{ form.recurrence_end_date.label }}
                    <span class="text-error">*</span>
                  </label>
                  {{ form.recurrence_end_date }}
                  {% if form.recurrence_end_date.help_text %}
                    <div class="form-text">{{ form.recurrence_end_date.help_text }}</div>
                  {% endif %}
                  {% if form.recurrence_end_date.errors %}
                    <div class="invalid-feedback d-block">{{ form.recurrence_end_date.errors.0 }}</div>
                  {% endif %}
                </div>
              {% elif event.is_recurring %}
                <!-- Show recurring info for existing events -->
                <div class="col-12">
                  <hr class="my-4" />
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <i data-feather="repeat" class="me-2 mt-1" style="width: 1.25rem; height: 1.25rem;"></i>
                      <div>
                        <strong>Herhalend evenement:</strong> {{ event.get_recurrence_display }}
                        <br />
                        <small class="text-muted">Dit evenement is onderdeel van een reeks van {{ recurring_events_count }} evenementen.</small>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>

            {% if event %}
              <!-- Event Info for Edit -->
              <div class="alert alert-light mt-4">
                <div class="d-flex align-items-start">
                  <i data-feather="info" class="me-2 mt-1" style="width: 1.25rem; height: 1.25rem;"></i>
                  <div>
                    <strong>Let op:</strong> Wijzigingen aan dit evenement zijn direct zichtbaar voor alle teamleden.
                    <br />
                    <small class="text-muted">
                      Aangemaakt op: {{ event.created_at|date:'d/m/Y H:i' }}
                      {% if event.created_at != event.updated_at %}
                        â€¢ Laatst bijgewerkt: {{ event.updated_at|date:'d/m/Y H:i' }}
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>

              <!-- Recurring Event Update Options -->
              {% if is_recurring_event %}
                <div class="alert alert-warning mt-3" id="recurring-update-options">
                  <div class="d-flex align-items-start">
                    <i data-feather="alert-triangle" class="me-2 mt-1" style="width: 1.25rem; height: 1.25rem;"></i>
                    <div class="w-100">
                      <strong>Herhalend evenement bewerken</strong>
                      <p class="mb-3 mt-2">
                        Dit evenement is onderdeel van een reeks van {{ recurring_events_count }} evenementen.{% if future_recurring_events_count %}
                          Er zijn nog {{ future_recurring_events_count }} toekomstige evenementen in deze reeks.
                        {% endif %}
                      </p>
                      <p class="mb-3">
                        <strong>Hoe wilt u de wijzigingen toepassen?</strong>
                      </p>

                      <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="update_series" value="false" id="update_single" checked />
                        <label class="form-check-label fw-medium" for="update_single">
                          <i data-feather="edit-3" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                          Alleen dit evenement bijwerken
                        </label>
                        <div class="form-text">Het evenement wordt losgemaakt van de reeks en individueel bijgewerkt. De andere evenementen in de reeks blijven ongewijzigd.</div>
                      </div>

                      {% if future_recurring_events_count > 0 %}
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="update_series" value="true" id="update_all" />
                          <label class="form-check-label fw-medium" for="update_all">
                            <i data-feather="copy" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
                            Alle toekomstige evenementen in de reeks bijwerken ({{ future_recurring_events_count }} evenementen)
                          </label>
                          <div class="form-text">Alle toekomstige evenementen in deze reeks krijgen dezelfde wijzigingen. De tijd wordt aangepast, maar de herhalingspatroon blijft behouden.</div>
                        </div>
                      {% else %}
                        <div class="alert alert-info mb-0 mt-2">
                          <small>
                            <i data-feather="info" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;"></i>
                            Er zijn geen toekomstige evenementen meer in deze reeks om bij te werken.
                          </small>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endif %}

            <hr class="my-4" />

            <!-- Form Actions -->
            <div class="d-flex justify-content-start align-items-start gap-1">
              <div class="">
                <button type="submit" class="btn btn-primary w-100">
                  {% if event %}
                    <i data-feather="save"></i>
                    Wijzigingen opslaan
                  {% else %}
                    <i data-feather="plus"></i>
                    Evenement aanmaken
                  {% endif %}
                </button>
              </div>

              {% if event %}
                <div class="ms-auto">
                  <a href="{% url 'events:delete' event.pk %}" class="btn btn-danger w-100">
                    <i data-feather="trash-2"></i>
                    Verwijderen
                  </a>
                </div>
              {% endif %}

              <div class="">
                <a href="{% url 'events:list' %}" class="btn btn-secondary w-100">
                  <i data-feather="x"></i>
                  Annuleren
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Flatpickr JavaScript for datepicker -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/nl.js"></script>
  <script>
    // Pass form field IDs and configuration to JavaScript
    window.recurrenceTypeFieldId = '{{ form.recurrence_type.id_for_label }}';
    window.recurrenceEndDateFieldId = '{{ form.recurrence_end_date.id_for_label }}';
    window.dateFieldId = '{{ form.date.id_for_label }}';
    window.descriptionFieldId = '{{ form.description.id_for_label }}';
    window.futureRecurringEventsCount = {{ future_recurring_events_count|default:0 }};
  </script>
  <script src="{% static 'js/events/event_form.js' %}"></script>
{% endblock %}
